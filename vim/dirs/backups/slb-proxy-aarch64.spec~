%define role proxy

Name:slb-%{role}
Version:19.04.2
#Release: %(echo $RELEASE)%{?dist}
Release: %(echo $RELEASE)
Summary: All-in-one package of proxy
Group: Applications/System
URL: git@gitlab.alibaba-inc.com:slb/slb-release.git
Source:%{name}-%{version}.tar.gz
Provides:%{name}-%{version}-%{release}
License:GPL
BuildRequires: createrepo, python-simplejson

# Disable the auto-strip by rpm-build, keep debuginfo
%global __os_install_post %{nil}

%description

%prep

%build
cd $OLDPWD/../

rm -rf $PWD/%{role}/rpms
./scripts/get_role_package.py ./release-notes/%{version}-release-note-%{role}-6u.json %{role} %{role}/alios6
./scripts/get_role_package.py ./release-notes/%{version}-release-note-%{role}-7u.json %{role} %{role}/alios7

%install
cd $OLDPWD/../
%{__install} -d %{buildroot}/home/slb/release/%{version}/%{role}

cp -rf %{role}/* %{buildroot}/home/slb/release/%{version}/%{role}


# Remove link file
rm -rf %{buildroot}/home/slb/release/%{version}/%{role}/scripts/common
cp -rf common %{buildroot}/home/slb/release/%{version}/%{role}/scripts/

chmod 0755 %{buildroot}/home/slb/release/%{version}/%{role}/scripts/
chmod 0755 %{buildroot}/home/slb/release/%{version}/%{role}/scripts/common

#create repo
cd %{buildroot}/home/slb/release/%{version}/%{role}/alios6
createrepo -v -o . . 
cd %{buildroot}/home/slb/release/%{version}/%{role}/alios7
createrepo -v -o . .

%pre
rm -f /home/slb/release/%{version}/%{role}/rpms
rm -f /home/slb/release/%{version}/%{role}/srv/salt

%post

if [ `uname -r | grep alios7` ]; then
    ln -s /home/slb/release/%{version}/%{role}/alios7 /home/slb/release/%{version}/%{role}/rpms
    ln -s /home/slb/release/%{version}/%{role}/srv/alios7/salt /home/slb/release/%{version}/%{role}/srv/salt
else
    ln -s /home/slb/release/%{version}/%{role}/alios6 /home/slb/release/%{version}/%{role}/rpms
    ln -s /home/slb/release/%{version}/%{role}/srv/alios6/salt /home/slb/release/%{version}/%{role}/srv/salt
fi


%preun

%postun

%clean
rm -rf $RPM_BUILD_ROOT
rm -rf $OLDPWD/../%{role}/rpms

%files
%defattr(0755,admin,admin)
/home/slb/release/%{version}/%{role}/*

%changelog
* Thu Jun 30 2016 jinshuai.js@alibaba-inc.com
- first create package
